<style>
/*
 * Gallery图片展示样式
 * 实现响应式图片轮播布局
 */

/* Gallery整体区域样式 */
.gallery-section {
  margin: 3rem 0;
  padding: 2rem 0;
  border-top: 1px solid #eaeaea;
}

/* Gallery标题样式 */
.gallery-section h2 {
  text-align: center;
  margin-bottom: 2rem;
  color: #333;
}

/* Gallery容器 - 包含图片轨道和导航按钮 */
.gallery-container {
  position: relative;
  max-width: 1000px;
  margin: 0 auto;
  overflow: hidden;
}

/* 图片轨道 - 水平滚动容器 */
.gallery-track {
  display: flex;
  gap: 40px;
  overflow-x: hidden; /* 禁用原生水平滚动，完全由JavaScript控制 */
  scroll-behavior: smooth;
  padding: 10px;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE and Edge */
  padding-left: calc(50% - 150px);
  padding-right: calc(50% - 150px);
}

.gallery-track::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}

/* 单个图片项样式 - 支持不同长宽比的图片 */
.gallery-item {
  flex: 0 0 auto;
  width: 300px;
  height: auto; /* 高度自适应图片比例 */
  min-height: 150px; /* 最小高度 */
  max-height: 400px; /* 最大高度限制，避免过高图片 */
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: transform 0.3s ease;
  display: flex;
  align-items: center; /* 垂直居中 */
  justify-content: center; /* 水平居中 */
  background-color: #f8f9fa; /* 背景色，用于图片留白区域 */
}

.gallery-item:hover {
  transform: translateY(-5px);
}

/* 当前居中的活动图片样式 */
.gallery-item.active {
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  transform: scale(1.05);
  z-index: 5;
}

/* 左侧图片梯形效果 - 向屏幕背面打开 */
.gallery-item.gallery-item-left {
  transform: perspective(500px) rotateY(-30deg) scale(0.75);
  opacity: 0.8;
  transform-origin: left center;
  z-index: 1;
}

/* 右侧图片梯形效果 - 向屏幕背面打开 */
.gallery-item.gallery-item-right {
  transform: perspective(500px) rotateY(30deg) scale(0.75);
  opacity: 0.8;
  transform-origin: right center;
  z-index: 1;
}

/* 左侧图片悬停效果 */
.gallery-item.gallery-item-left:hover {
  transform: perspective(500px) rotateY(-30deg) scale(0.75) translateY(-5px);
  opacity: 0.9;
}

/* 右侧图片悬停效果 */
.gallery-item.gallery-item-right:hover {
  transform: perspective(500px) rotateY(30deg) scale(0.75) translateY(-5px);
  opacity: 0.9;
}

/* 活动图片悬停效果 */
.gallery-item.active:hover {
  transform: scale(1.05) translateY(-5px);
}

/* 图片样式 - 保持原始比例，完整显示不裁剪 */
.gallery-item img {
  max-width: 100%; /* 最大宽度不超过容器 */
  max-height: 100%; /* 最大高度不超过容器 */
  width: auto; /* 宽度自适应 */
  height: auto; /* 高度自适应 */
  object-fit: contain; /* 完整显示图片，可能有留白 */
  display: block;
}

/* 导航按钮基础样式 */
.gallery-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.9);
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s ease;
}

.gallery-btn:hover {
  background: white;
}

/* 左箭头按钮位置 */
.gallery-btn.prev {
  left: 15px;
}

/* 右箭头按钮位置 */
.gallery-btn.next {
  right: 15px;
}

/* 按钮禁用状态样式（在循环滚动中不再使用） */
.gallery-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* 空状态提示样式（当没有图片时显示） */
.gallery-empty {
  text-align: center;
  padding: 3rem;
  color: #666;
  font-style: italic;
}

/* 移动端响应式样式 */
@media (max-width: 768px) {
  .gallery-item {
    width: 250px;
    height: auto; /* 高度自适应图片比例 */
    min-height: 120px; /* 移动端最小高度 */
    max-height: 300px; /* 移动端最大高度限制 */
  }

  .gallery-btn {
    width: 40px;
    height: 40px;
    font-size: 1.2rem;
  }
}
</style>

<!--
  Gallery图片展示区域
  自动加载 assets/images/gallery/ 目录下的所有图片
  支持格式：JPG, JPEG, PNG, GIF, WebP
  实现循环滚动效果，左右箭头可无限循环浏览
-->
<section class="gallery-section">
  <h2>Gallery</h2>

  {% comment %} Get all image files from the gallery directory {% endcomment %}
  {% assign gallery_images = site.static_files | where_exp: "file", "file.path contains 'assets/images/gallery/'" %}
  {% assign image_extensions = ".jpg,.jpeg,.png,.gif,.webp" | split: "," %}

  {% assign valid_images = "" | split: "" %}
  {% for file in gallery_images %}
    {% assign ext = file.extname | downcase %}
    {% if image_extensions contains ext %}
      {% assign valid_images = valid_images | push: file %}
    {% endif %}
  {% endfor %}

  <div class="gallery-container">
    {% if valid_images.size > 0 %}
      <div class="gallery-track" id="gallery-track">
        {% for image in valid_images %}
          <div class="gallery-item">
            <img src="{{ image.path }}" alt="Gallery image {{ forloop.index }}" loading="lazy">
          </div>
        {% endfor %}
      </div>

      {% if valid_images.size > 1 %}
        <button class="gallery-btn prev" id="prev-btn" aria-label="Previous image">❮</button>
        <button class="gallery-btn next" id="next-btn" aria-label="Next image">❯</button>
      {% endif %}
    {% else %}
      <div class="gallery-empty">
        <p>No images in the gallery yet. Add images to <code>assets/images/gallery/</code> directory.</p>
        <p>Supported formats: JPG, JPEG, PNG, GIF, WebP</p>
      </div>
    {% endif %}
  </div>
</section>

<script>
// 图片轮播的JavaScript逻辑 - 实现循环滚动效果
document.addEventListener('DOMContentLoaded', function() {
  // 获取DOM元素
  const track = document.getElementById('gallery-track');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  // 如果没有track元素，直接返回
  if (!track) return;

  // 获取所有图片项
  const galleryItems = track.querySelectorAll('.gallery-item');

  // 如果图片数量少于2张，隐藏左右按钮
  if (galleryItems.length <= 1) {
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
    return;
  }

  // 计算单个图片项的宽度（包括间距）
  let itemWidth = galleryItems[0].offsetWidth + 40; // 40px是CSS中设置的gap
  let scrollAmount = itemWidth; // 每次滚动1个图片的宽度（修改为1张）
  let paddingLeft = parseFloat(getComputedStyle(track).paddingLeft);

  // 计算容器和轨道的基本尺寸
  let containerWidth = track.clientWidth;
  let maxScroll = track.scrollWidth - containerWidth;

  // 当前居中显示的图片索引（从0开始）
  let currentIndex = 0;
  // 标记是否正在进行滚轮操作（防抖）
  let isWheeling = false;
  // 滚轮水平滚动累积值（用于控制滑动灵敏度）
  let wheelDeltaXAccumulated = 0;
  // 触发切换的阈值（像素），默认值为图片宽度的60%
  let wheelThreshold = 0;

  // 计算让指定索引的图片居中的滚动位置
  function getScrollPositionForIndex(index) {
    // 确保索引在有效范围内（循环处理）
    const itemCount = galleryItems.length;
    if (index < 0) index = itemCount - 1;
    if (index >= itemCount) index = 0;

    // 计算目标图片的中心位置
    const targetCenter = paddingLeft + index * itemWidth + itemWidth / 2;

    // 计算需要滚动到的位置，使目标图片居中
    let scrollPosition = targetCenter - containerWidth / 2;

    // 限制滚动范围，确保不超出边界
    scrollPosition = Math.max(0, Math.min(scrollPosition, maxScroll));

    return { scrollPosition, adjustedIndex: index };
  }

  // 滚动到指定索引的图片，使其居中显示
  function scrollToIndex(index, smooth = true) {
    const { scrollPosition, adjustedIndex } = getScrollPositionForIndex(index);
    currentIndex = adjustedIndex;

    // 执行滚动
    track.scrollTo({
      left: scrollPosition,
      behavior: smooth ? 'smooth' : 'auto'
    });

    // 更新UI状态
    updateActiveItem();
  }

  // 更新当前活动图片的样式
  function updateActiveItem() {
    // 移除所有图片的active类和其他位置类
    galleryItems.forEach(item => {
      item.classList.remove('active', 'gallery-item-left', 'gallery-item-right', 'gallery-item-center');
    });

    // 为当前图片添加active类和center类
    if (galleryItems[currentIndex]) {
      galleryItems[currentIndex].classList.add('active', 'gallery-item-center');
    }

    // 为左侧图片添加left类
    for (let i = 0; i < currentIndex; i++) {
      galleryItems[i].classList.add('gallery-item-left');
    }

    // 为右侧图片添加right类
    for (let i = currentIndex + 1; i < galleryItems.length; i++) {
      galleryItems[i].classList.add('gallery-item-right');
    }
  }

  // 向左滚动（显示前一张图片）
  function scrollPrev() {
    scrollToIndex(currentIndex - 1);
  }

  // 向右滚动（显示后一张图片）
  function scrollNext() {
    scrollToIndex(currentIndex + 1);
  }

  // 左箭头按钮点击事件
  if (prevBtn) {
    prevBtn.addEventListener('click', scrollPrev);
  }

  // 右箭头按钮点击事件
  if (nextBtn) {
    nextBtn.addEventListener('click', scrollNext);
  }

  // 监听窗口大小变化事件，重新计算并调整位置
  window.addEventListener('resize', function() {
    // 重新计算尺寸
    itemWidth = galleryItems[0].offsetWidth + 40;
    scrollAmount = itemWidth;
    paddingLeft = parseFloat(getComputedStyle(track).paddingLeft);
    containerWidth = track.clientWidth;
    maxScroll = track.scrollWidth - containerWidth;

    // 重新滚动到当前索引，确保图片仍然居中
    scrollToIndex(currentIndex, false);
  });

  // 注意：由于设置了 overflow-x: hidden，用户无法手动滚动轨道
  // 因此不需要 scroll 事件的自动校正逻辑
  // 移除 scroll 事件监听器以避免与程序滚动冲突

  // 初始状态：让第二张图片居中显示
  scrollToIndex(1, false);

  // 添加键盘支持（可选功能）
  document.addEventListener('keydown', function(event) {
    if (event.key === 'ArrowLeft') {
      scrollPrev();
      event.preventDefault();
    } else if (event.key === 'ArrowRight') {
      scrollNext();
      event.preventDefault();
    }
  });

  // 添加触控板/鼠标滚轮支持
  const galleryContainer = track.parentElement;
  galleryContainer.addEventListener('wheel', function(event) {
    // 检查是否为水平滚动
    if (Math.abs(event.deltaX) > Math.abs(event.deltaY)) {
      // 阻止默认水平滚动行为
      event.preventDefault();

      // 累积水平滚动值
      wheelDeltaXAccumulated += event.deltaX;

      // 计算阈值（图片宽度的80%），确保至少为50px
      const threshold = Math.max(itemWidth * 0.8, 50);

      // 检查累积值是否超过阈值（正或负）
      if (Math.abs(wheelDeltaXAccumulated) >= threshold) {
        // 根据方向只切换一张图片（不再按步数切换多张）
        if (wheelDeltaXAccumulated > 0) {
          // 向右滚动 -> 显示下一张图片
          scrollNext();
        } else {
          // 向左滚动 -> 显示上一张图片
          scrollPrev();
        }

        // 重置累积值（不从阈值中保留余数）
        wheelDeltaXAccumulated = 0;

        // 设置防抖标志，防止短时间内重复触发
        if (!isWheeling) {
          isWheeling = true;
          setTimeout(() => {
            isWheeling = false;
          }, 300);
        }
      }

      return false;
    }
    // 如果是垂直滚动，允许正常滚动页面
  }, { passive: false });

  // 添加触摸滑动支持（适用于触摸屏设备）
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  let isTouchScrolling = false;

  track.addEventListener('touchstart', function(event) {
    if (event.touches.length === 1) {
      touchStartX = event.touches[0].clientX;
      touchStartY = event.touches[0].clientY;
      isTouchScrolling = true;
    }
  }, { passive: true });

  track.addEventListener('touchmove', function(event) {
    if (!isTouchScrolling || event.touches.length !== 1) return;

    // 轻微阻止默认行为，但保持passive以提高性能
    event.preventDefault();

    touchEndX = event.touches[0].clientX;
    touchEndY = event.touches[0].clientY;
  }, { passive: false });

  track.addEventListener('touchend', function(event) {
    if (!isTouchScrolling) return;

    const touchDiffX = touchStartX - touchEndX;
    const touchDiffY = touchStartY - touchEndY;

    // 如果水平滑动距离大于垂直滑动距离，且超过最小阈值，则切换图片
    if (Math.abs(touchDiffX) > Math.abs(touchDiffY) && Math.abs(touchDiffX) > 30) {
      if (touchDiffX > 0) {
        // 向左滑动 -> 显示下一张图片
        scrollNext();
      } else {
        // 向右滑动 -> 显示上一张图片
        scrollPrev();
      }
      event.preventDefault();
    }

    isTouchScrolling = false;
  });
});
</script>